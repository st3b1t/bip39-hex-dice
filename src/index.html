<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hex Dice üé≤ Bip39 Mnemonic Generator</title>
<link href="../node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="dices.css" rel="stylesheet" type="text/css">
<link href="main.css" rel="stylesheet" type="text/css">
<script src="wordlists/chinese_simplified.js"></script>
<script src="wordlists/chinese_traditional.js"></script>
<script src="wordlists/czech.js"></script>
<script src="wordlists/english.js"></script>
<script src="wordlists/french.js"></script>
<script src="wordlists/italian.js"></script>
<script src="wordlists/japanese.js"></script>
<script src="wordlists/korean.js"></script>
<script src="wordlists/portuguese.js"></script>
<script src="wordlists/spanish.js"></script>
<script src="utils.js"></script>
</head>
<body>
    <h1>Hex Dice üé≤ Bip39 Mnemonic Generator</h1>

    <div row class="row">
        <div class="col-8">
            <div class="toast-container position-fixed bottom-0 end-0 p-3">
                <div id="alert" class="toast align-items-center text-bg-warning border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            </div>

            <div id="intro" class="my-4" >
                Generate a 12-24 words BIP39 mnemonic phrase using hex dice, inspired:
                <a href="http://bitup.space/8ff/" target="_blank" rel="noopener">bitup.space/8ff</a>
                |
                <a href="https://iancoleman.io/bip39/" target="_blank" rel="noopener">iancoleman.io/bip39</a>
                <br />
                author <a href="https://x.com/st3b1t" target="_blank" rel="noopener">st3b1t</a>
                | <a href="https://github.com/st3b1t/bip39-hex-dice" target="_blank" rel="noopener">Github Sources</a>
            </div>

            <div id="optionSection" class="my-4">
                <div class="row align-items-center mb-2">
                    <div class="col-2">
                        <label for="mnemonicLength" class="form-label mb-0">Mnemonic length:</label>
                    </div>
                    <div class="col-auto">
                        <select id="mnemonicLength" class="form-select d-inline-block w-auto" aria-label="Mnemonic length">
                            <option value="12" selected>12</option>
                            <option value="15">15</option>
                            <option value="18">18</option>
                            <option value="21">21</option>
                            <option value="24">24</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        words
                    </div>
                </div>
                
                <div class="row align-items-center mb-2">
                    <div class="col-2">
                        <label for="mnemonicLanguage" class="form-label mb-0">Mnemonic Language:</label>
                    </div>
                    <div class="col-10">
                        <div id="langlist" class="d-flex flex-wrap gap-2">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="wordlist" id="langEnglish" value="english" checked>
                                <label class="form-check-label" for="langEnglish">English</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="wordlist" id="langSpanish" value="spanish">
                                <label class="form-check-label" for="langSpanish">Espa√±ol</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="wordlist" id="langFrench" value="french">
                                <label class="form-check-label" for="langFrench">Fran√ßais</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="wordlist" id="langItalian" value="italian">
                                <label class="form-check-label" for="langItalian">Italiano</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="wordlist" id="langCzech" value="czech">
                                <label class="form-check-label" for="langCzech">ƒåe≈°tina</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="wordlist" id="langPortuguese" value="portuguese">
                                <label class="form-check-label" for="langPortuguese">Portugu√™s</label>
                            </div>
                            <div class="w-100"></div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="wordlist" id="langPolish" value="polish">
                                <label class="form-check-label" for="langPolish">Polski</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="wordlist" id="langRussian" value="russian">
                                <label class="form-check-label" for="langRussian">–†—É—Å—Å–∫–∏–π</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="wordlist" id="langJapanese" value="japanese">
                                <label class="form-check-label" for="langJapanese">Êó•Êú¨Ë™û</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="wordlist" id="langChineseSimplified" value="chinese_simplified">
                                <label class="form-check-label" for="langChineseSimplified">‰∏≠Êñá(ÁÆÄ‰Ωì)</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="wordlist" id="langChineseTraditional" value="chinese_traditional">
                                <label class="form-check-label" for="langChineseTraditional">‰∏≠Êñá(ÁπÅÈ´î)</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="wordlist" id="langKorean" value="korean">
                                <label class="form-check-label" for="langKorean">ÌïúÍµ≠Ïñ¥</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="entrySection" class="my-4">
                <form class="row g-2 align-items-center" onsubmit="return false;">
                    <div class="col-auto">
                        <label for="diceInput" class="col-form-label">
                            Enter dice roll for word <b>#<span id="wordCounter">1</span></b>:
                        </label>
                    </div>
                    <div class="col-auto">
                        <input autofocus type="text" id="diceInput" maxlength="3" size="5" class="form-control" autocomplete="off" />
                    </div>
                    <div class="col-auto">
                        <div id="diceSelect" class="input-group">
                            <select data-index="0" class="form-select" aria-label="8-sided dice">
                                <option value="-"></option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                            </select>
                            <select data-index="1" class="form-select" aria-label="16-sided dice A">
                                <option value="-"></option>
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="a">A</option>
                                <option value="b">B</option>
                                <option value="c">C</option>
                                <option value="d">D</option>
                                <option value="e">E</option>
                                <option value="f">F</option>
                            </select>
                            <select data-index="2" class="form-select" aria-label="16-sided dice B">
                                <option value="-"></option>
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="a">A</option>
                                <option value="b">B</option>
                                <option value="c">C</option>
                                <option value="d">D</option>
                                <option value="e">E</option>
                                <option value="f">F</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-auto" id="submitWordWrapper">
                        <button id="submitWord" type="button" class="btn btn-primary">Add</button>
                        <a id="submitWordAuto" type="button" class="btn btn-link">
                            Simulate Roll
                        </a>
                        <!-- <i class="text-danger">(only for debug!)</i> -->
                    </div>
                </form>
            </div>
            
            <div id="resultsSection" class="my-4">
                <fieldset class="mb-4" style="display: none">
                    <legend>Mnemonic Words:</legend>
                    <div id="enteredWords">
                    </div>
                </fieldset>
                <fieldset class="mb-4" style="display: none">
                    <legend>Possible Final Word:</legend>
                    <div id="finalWords">
                    </div>
                </fieldset>
                <fieldset class="mb-4" style="display: none">
                    <legend>Result Mnemonic:</legend>
                    <textarea id="resultWordsText" class="form-control mt-2" rows="3" readonly></textarea>
                    <button id="copyBtn" class="btn btn-primary mt-2">Copy</button>
                </fieldset>
                <button id="resetBtn" class="btn btn-secondary mt-2">Reset</button>
            </div>
        </div>
        <div class="col-4 d-flex">
            <div id="howto" class="card w-100" role="alert">
                <div class="card-body">
                    <button type="button" class="btn-close float-end" data-bs-dismiss="alert" aria-label="Close" onclick="this.closest('#howto').style.display='none';"></button>                    
                    <h5 class="card-title">How-To:</h5>
                    <p class="card-text">
                        <ol>
                            <li>Get one 8-sided die and two 16-sided dice, as shown in the image below.</li>
                            <li>Select the mnemonic length (12-24 words).</li>
                            <li>Choose the language for the mnemonic words.</li>
                            <li>Enter the dice rolls for each word.</li>
                            <li>Click "Add" to submit the word.</li>
                            <li>After entering the required number of words, select the final word from the generated list.</li>
                        </ol>
                        <span id="dices"></span>
                    </p>
                </div>
            </div>
        </div>
    </div>
    <script>
        Element.prototype.on = Element.prototype.addEventListener;
        Element.prototype.off = Element.prototype.removeEventListener;
        Element.prototype.trigger = function(eName) {
            this.dispatchEvent(new Event(eName, { bubbles: true, cancelable: true }));
        };
        const create = function(tag, className = '', textContent = '') {
            const el = document.createElement(tag);
            if (className) el.className = className;
            if (textContent) el.textContent = textContent;
            return el;
        }
        const $ = document.getElementById.bind(document);
        // Element.prototype.find = function(selector) {
        //     return {
        //         each: (callback) => {
        //             this.querySelectorAll(selector).forEach(callback);
        //         }
        //     };
        // };
        // minimal polyfill         

        const $alertDiv = $('alert');
        const $mnemonicLength = $('mnemonicLength');
        const $wordCounter = $('wordCounter');
        const $diceInput = $('diceInput');
        const $diceSelect = $('diceSelect');
        const $submitWord = $('submitWord');
        const $submitWordAuto = $('submitWordAuto');
        const $entrySection = $('entrySection');
        const $resultsSection = $('resultsSection');
        const $langlist = $('langlist');        
        const $enteredWords = $('enteredWords');        
        const $finalWords = $('finalWords');
        const $resultWords = $('resultWordsText');
        const $resetBtn = $('resetBtn');
        const $copyBtn = $('copyBtn');

        let enteredWords = [];
        let mnemonicLength = parseInt($mnemonicLength.value);

        const defaultLang = $langlist.querySelector('input[name="wordlist"]:checked').value;
        let WORDLIST = WORDLISTS[defaultLang || 'english'];

        $langlist.querySelectorAll('input[name="wordlist"]').forEach(input => {
            input.on('change', function() {
                const lang = this.value;
                if (WORDLISTS[lang]) {
                    WORDLIST = WORDLISTS[lang];
                    reset();
                } else {
                    console.error("Wordlist for language '" + lang + "' not found.");
                }
            });
        });

        $alertDiv.querySelector('.btn-close').on('click', function() {
            $alertDiv.classList.remove('show');
            $alertDiv.style.display = 'none';
        });

        $mnemonicLength.on('change', function() {
            mnemonicLength = parseInt(this.value);
            reset();
        });

        function reset() {
            enteredWords = [];
            $wordCounter.textContent = "1";
            $entrySection.style.display = 'block';
            $resultWords.parentElement.style.display = 'none';
            $enteredWords.parentElement.style.display = 'none';
            $finalWords.parentElement.style.display = 'none';
            $enteredWords.innerHTML = '';
            $finalWords.innerHTML = '';
            $diceInput.value = '';
            $diceSelect.querySelectorAll('select').forEach(select => {
                select.value = '';
            });
            $diceInput.focus();
        }
            
        function showAlert(message) {
            $alertDiv.querySelector('.toast-body').textContent = message;
            $alertDiv.classList.add('show');
            $alertDiv.style.display = 'block';
            // Hide after 5 seconds
            clearTimeout($alertDiv._hideTimeout);
            $alertDiv._hideTimeout = setTimeout(() => {
                $alertDiv.classList.remove('show');
                $alertDiv.style.display = 'none';
            }, 5000);
        }

        function createWord(word, onClick = null) {
            const wordEl = create('span', 'word-item', word);
            if (onClick) {
                wordEl.className += ' btn btn-primary';
                wordEl.on('click', e => {
                    e.preventDefault();
                    onClick(word);
                });
            };
            return wordEl;
        }
        
        function updateEnteredWords() {
            $enteredWords.parentElement.style.display = 'block';
            $enteredWords.innerHTML = '';
            enteredWords.forEach((word, index) => {
                const wordEl = createWord(`${index + 1}. ${word}`);
                if (index > 0 && index % 6 === 0) {
                    $enteredWords.appendChild(create('br'));
                }
                $enteredWords.appendChild(wordEl);
            });
        }

        async function handleFinalWordSelection(onClick) {
            $finalWords.parentElement.style.display = 'block';
            $finalWords.textContent = `Calculating possible final words for a ${mnemonicLength}-word seed...`;

            const valid_last = await genFinalWords(enteredWords);

            $finalWords.innerHTML = `Choose one of these <b>${valid_last.length} words</b> as the final mnemonic word:<br />`;
            valid_last.forEach((word) => {
                const wordEl = createWord(word, async (word) => { //on click final word
                    enteredWords.push(word);
                    updateEnteredWords();
                    $finalWords.parentElement.style.display = 'none';
                    $resultWords.parentElement.style.display = 'block';
                    $resultWords.value = enteredWords.join(' ');
                    $resultWords.focus();
                });
                $finalWords.appendChild(wordEl);
            });
        }

        async function handleSubmitWord(empty = true) {
            const entry = $diceInput.value.trim().toUpperCase();
            if (!entry) return;

            try {
                const { word, index } = decodeEntry(entry);
                enteredWords.push(word);

                await updateEnteredWords();

                if(empty) {
                    $diceInput.value = '';
                    $diceSelect.querySelectorAll('select').forEach(select => {
                        select.value = '';
                    });
                }
                
                if (enteredWords.length < mnemonicLength - 1) { //next word
                    $wordCounter.textContent = enteredWords.length + 1;
                    //$diceInput.focus();
                } else {
                    $entrySection.style.display = 'none';
                    await handleFinalWordSelection();
                }

            } catch (e) {
                showAlert(e.message);
                $diceInput.select();
            }
        }

        $submitWord.on('click', handleSubmitWord);
        $diceInput.on('keyup', (e) => {
            if (e.key === "Enter") {
                handleSubmitWord();
            }
            else {
                $diceSelect.querySelectorAll('select').forEach(select => {
                    select.value = $diceInput.value.length > 0 ? $diceInput.value[select.dataset.index] : '';
                    });
            }
        });

        $diceSelect.querySelectorAll('select').forEach(select => {
            select.on('change', e => {
                const diceValues = Array.from($diceSelect.querySelectorAll('select')).map(select => select.value).join('');
                $diceInput.value = diceValues;
            });
        });

        $submitWordAuto.on('click', async (e) => {
            //automatize 12 words generation for debug only simulate click on button
            //let maxInterval= 0;
            // const intervalId = setInterval(async () => {
            //     if (maxInterval++ >= mnemonicLength-1) {
            //         clearInterval(intervalId);
            //         return;
            //     }
                $diceInput.value = await getRandomFace();
                $diceSelect.querySelectorAll('select').forEach(select => {
                    
                        select.value = $diceInput.value.length > 0 ? $diceInput.value[select.dataset.index] : ''; 

                    });
                handleSubmitWord(false);
            //}, 300);
        });

        $resultWords.on('click', () => {
            $resultWords.select();
        });

        $copyBtn.on('click', () => {
            $resultWords.trigger('click');
            navigator.clipboard.writeText($resultWords.value).catch(err => {
                console.error('Failed to copy: ', err);
                showAlert("Failed to copy mnemonic phrase to clipboard.");
            }); 
            showAlert("Mnemonic phrase copied to clipboard.");
        });

        $resetBtn.on('click', reset);

    </script>
</body>
</html> 